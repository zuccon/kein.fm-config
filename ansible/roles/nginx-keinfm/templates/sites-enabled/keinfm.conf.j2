# {{ ansible_managed }}
# kein.fm radio
# web server nginx site
server {

  listen 80;

  # TODO: enable SSL.
	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	root {{ nginx_keinfm__html_path }};

	index index.html;
    server_name wirklich; # managed by Certbot


	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}

	location /recordings/ {
		autoindex on;
	}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	#location ~ /\.ht {
	#	deny all;
	#}


    #listen [::]:443 ssl ipv6only=on; # managed by Certbot

        # This URL provides RTMP statistics in XML
  location /stat {
    rtmp_stat all;

    # Use this stylesheet to view XML as web page
    # in browser
    rtmp_stat_stylesheet stat.xsl;
  }

  location /stat.xsl {
    # XML stylesheet to view RTMP stats.
    # Copy stat.xsl wherever you want
    # and put the full directory path here
    root {{ nginx_keinfm__html_path }};
  }

  # creates the http-location for our full-resolution (desktop) HLS stream - "http://my-ip/live/my-stream-key/index.m3u8"      
  location /live {
    types {
      application/vnd.apple.mpegurl m3u8;
    }
    alias /tmp/HLS/live;
    add_header Cache-Control no-cache;
  }

  # Keeping them here just in case.
  #creates the http-location for our mobile-device HLS stream - "http://my-ip/mobile/my-stream-key/index.m3u8"        
  # location /mobile {
  # types {
  # application/vnd.apple.mpegurl m3u8;
  # }
  # alias /tmp/HLS/mobile;
  # add_header Cache-Control no-cache;
  # }   

  # location /hls {
  #     # Serve HLS fragments
  #     types {
  #         application/vnd.apple.mpegurl m3u8;
  #         video/mp2t ts;
  #     }
  #     root /tmp;
  #     add_header Cache-Control no-cache;
  # }

  # location /dash {
  #     # Serve DASH fragments
  #     root /tmp;
  #     add_header Cache-Control no-cache;
  # }
}
